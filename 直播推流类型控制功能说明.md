# 直播推流类型控制功能说明

## 功能概述

新增了直播推流类型控制功能，支持两种不同的推流模式：

1. **FFmpeg直接输出模式**（默认） - 使用FFmpeg直接输出HTTP FLV流
2. **ZLMediaKit服务器模式** - 通过ZLM服务器进行RTMP/HLS/FLV推流

## 新增参数

### `stream_type` 参数

- **类型**: `string`
- **可选值**: `"ffmpeg"` | `"zlm"`
- **默认值**: `"ffmpeg"`
- **描述**: 控制直播推流的类型和方式

```json
{
  "task_id": "your_task_id",
  "enable_encoding": true,
  "format": "flv",
  "quality": 80,
  "fps": 15,
  "stream_type": "ffmpeg"  // 新增参数
}
```

## 两种推流模式详细说明

### 1. FFmpeg直接输出模式 (`stream_type: "ffmpeg"`)

#### 特点
- **默认模式**，无需额外配置ZLMediaKit服务器
- 直接使用FFmpeg内置HTTP服务器提供FLV流
- 延迟更低，资源占用更少
- 适合简单的直播需求

#### 技术实现
- FFmpeg进程直接监听HTTP端口
- 输出格式固定为FLV
- 每个任务分配不同的端口（基于任务ID hash计算）
- 提供HTTP FLV播放地址

#### 播放地址格式
```json
{
  "play_urls": {
    "http_flv": "http://127.0.0.1:8081/live.flv",
    "description": "FFmpeg直接输出的HTTP FLV流，包含实时分析结果"
  }
}
```

#### 适用场景
- 单一客户端播放
- 低延迟要求
- 简化部署环境
- 内网测试和开发

### 2. ZLMediaKit服务器模式 (`stream_type: "zlm"`)

#### 特点
- 通过专业的流媒体服务器ZLMediaKit进行推流
- 支持多种播放协议：RTMP、HLS、FLV、WebRTC
- 支持多客户端同时观看
- 提供完整的流媒体服务功能

#### 技术实现
- FFmpeg推流到ZLM的RTMP服务
- ZLM自动转换为多种播放格式
- 支持录制、回放等高级功能
- 可配置推流鉴权和播放控制

#### 播放地址格式
```json
{
  "play_urls": {
    "rtmp": "rtmp://127.0.0.1:1935/live/stream_id",
    "hls": "http://127.0.0.1:8080/live/stream_id.m3u8",
    "flv": "http://127.0.0.1:8080/live/stream_id.flv",
    "webrtc": "http://127.0.0.1:8080/index.html?app=live&stream=stream_id&type=webrtc"
  }
}
```

#### 适用场景
- 多客户端同时观看
- 需要录制功能
- 生产环境部署
- 需要完整流媒体服务

## API使用示例

### 启动FFmpeg直接输出流（默认）

```bash
curl -X POST "http://localhost:8000/api/v1/tasks/video" \
-H "Content-Type: application/json" \
-d '{
  "task_id": "your_task_id",
  "enable_encoding": true,
  "format": "flv",
  "quality": 80,
  "fps": 15,
  "stream_type": "ffmpeg"
}'
```

### 启动ZLM服务器推流

```bash
curl -X POST "http://localhost:8000/api/v1/tasks/video" \
-H "Content-Type: application/json" \
-d '{
  "task_id": "your_task_id", 
  "enable_encoding": true,
  "format": "rtmp",
  "quality": 80,
  "fps": 15,
  "stream_type": "zlm"
}'
```

## 向后兼容性

- 如果不指定`stream_type`参数，默认使用`"ffmpeg"`模式
- 现有的API调用无需修改即可正常工作
- 所有现有功能保持不变

## 性能对比

| 特性 | FFmpeg直接输出 | ZLM服务器 |
|------|-------------|----------|
| 延迟 | 更低 | 稍高 |
| 资源占用 | 更少 | 稍多 |
| 并发观看 | 有限 | 无限制 |
| 播放协议 | HTTP FLV | 多协议 |
| 部署复杂度 | 简单 | 复杂 |
| 功能丰富度 | 基础 | 完整 |

## 注意事项

1. **端口分配**: FFmpeg直接输出模式会动态分配HTTP端口，需要确保端口范围可用
2. **防火墙设置**: 两种模式使用不同的端口，需要相应配置防火墙规则
3. **性能监控**: 建议监控FFmpeg进程状态和网络带宽使用情况
4. **ZLM依赖**: ZLM模式需要ZLMediaKit服务器正常运行

## 配置建议

### 开发和测试环境
- 推荐使用`"ffmpeg"`模式
- 简单快速，便于调试

### 生产环境
- 单客户端场景：`"ffmpeg"`模式
- 多客户端场景：`"zlm"`模式
- 需要录制回放：`"zlm"`模式 